{% extends "base.html" %}
{% block title %}Histórico Financeiro{% endblock %}

{% block content %}

<style id="historico-inline-css">
  :root{
    --header-h: 80px;            
    --sidebar-collapsed: 82px;   
    --sidebar-expanded: 220px;   
    --cor-roxo:#4f46e5;
  }

  header{ position: fixed !important; top:0; left:0; right:0; z-index: 99999 !important; }
  #sidebar{ position: fixed !important; z-index: 99998 !important; }

  .hist-navbar-spacer{ height: var(--header-h); }

  #historico-main{
    position: relative; 
    z-index: 1;                   
    margin-left: var(--sidebar-collapsed);
    min-height: calc(100vh - var(--header-h));
    transition: margin-left .4s ease;
    padding: 20px;
    background: #f5f6fa;
  }

  #historico-main.is-sidebar-open{
    margin-left: var(--sidebar-expanded);
  }

  .hist-container{ font-family: 'Segoe UI',sans-serif; }
  .page-hero{ background:#fff; border:1px solid #e5e5e5; border-radius:12px; }
  #month-buttons button{
    border:1px solid #ddd; background:#fff; border-radius:8px; padding:6px 10px; transition:.2s;
  }
  #month-buttons button.active{ background:var(--cor-roxo); color:#fff; border-color:var(--cor-roxo); }
  .kpi-card{ background:#fff; border:1px solid #e5e5e5; text-align:center; border-radius:12px; }
  .kpi-label{ color:#777; font-size:.9rem }
  .kpi-value{ font-size:1.8rem; font-weight:700; color:#111 }
  .table thead th{ border-bottom:2px solid #eee; }
  .progress-outer{ background:#eee; border-radius:10px; height:10px; overflow:hidden; }
  .progress-inner{ background:var(--cor-roxo); height:100%; }
  .meta-card{ background:#fff; border:1px solid #eee; border-radius:12px; padding:15px; }
  .meta-title{ font-weight:600; }

  @media (max-width: 767.98px){
    #historico-main{ margin-left: 0 !important; }
  }
</style>

<div class="hist-navbar-spacer" aria-hidden="true"></div>

<main id="historico-main">
  <div class="container-lg hist-container py-3 py-md-4">

    <section class="page-hero p-4 p-md-5 mb-3 text-center">
      <h1 class="display-6 fw-semibold mb-2">Histórico Financeiro</h1>
      <p class="text-muted mb-0">Resumo mensal de Orçamento e Metas</p>
    </section>

    <section id="controls" class="mb-3">
      <div class="row g-3 align-items-center">
        <div class="col-12 col-md">
          <div id="month-buttons" class="d-flex flex-wrap gap-2"></div>
        </div>
        <div class="col-6 col-md-auto">
          <select id="year-select" class="form-select"></select>
        </div>
        <div class="col-6 col-md-auto d-flex gap-2 justify-content-end">
          <button id="btn-refresh" class="btn btn-outline-secondary">
            <i class="fa-solid fa-rotate"></i> Atualizar
          </button>
        </div>
      </div>
    </section>

    <section id="kpis" class="mb-4">
      <div class="row g-3">
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="kpi-card shadow-sm p-3">
            <div class="kpi-label">Receitas</div>
            <div class="kpi-value" id="kpi-receitas">—</div>
            <div class="kpi-sub text-muted">Somatório do mês</div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="kpi-card shadow-sm p-3">
            <div class="kpi-label">Despesas</div>
            <div class="kpi-value" id="kpi-despesas">—</div>
            <div class="kpi-sub text-muted">Somatório do mês</div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="kpi-card shadow-sm p-3">
            <div class="kpi-label">Saldo</div>
            <div class="kpi-value" id="kpi-saldo">—</div>
            <div class="kpi-sub text-muted">Receitas - Despesas</div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="kpi-card shadow-sm p-3">
            <div class="kpi-label">% Metas Concluídas</div>
            <div class="kpi-value" id="kpi-metas">—</div>
            <div class="kpi-sub text-muted">Metas do mês</div>
          </div>
        </div>
      </div>
    </section>

    <section class="mb-4">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Visão Geral do Mês</h5>
            <small class="text-muted" id="range-label">—</small>
          </div>
          <div class="chart-wrap">
            <canvas id="chart-mes" height="120"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section class="mb-4">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="fa-solid fa-wallet me-2"></i>Orçamento</h5>
            <span class="badge bg-light text-dark" id="orcamento-total">—</span>
          </div>
          <div class="table-responsive">
            <table class="table align-middle" id="table-orcamento">
              <thead>
                <tr>
                  <th>Categoria</th>
                  <th class="text-end">Previsto</th>
                  <th class="text-end">Gasto</th>
                  <th class="text-end">Saldo</th>
                  <th style="width: 260px;">Progresso</th>
                </tr>
              </thead>
              <body></body>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="mb-5">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="fa-solid fa-flag-checkered me-2"></i>Metas</h5>
            <span class="badge bg-light text-dark" id="metas-resumo">—</span>
          </div>
          <div id="metas-list" class="d-grid gap-3"></div>
        </div>
      </div>
    </section>

  </div>
</main>

<script>
(function(){
  'use strict';

  function applyOffsets(){
    const main    = document.getElementById('historico-main');
    const spacer  = document.querySelector('.hist-navbar-spacer');
    const header  = document.querySelector('header');
    const sidebar = document.getElementById('sidebar');

    if (!main || !spacer) return;

    const headerH = header ? header.offsetHeight : 80;
    spacer.style.height = headerH + 'px';
    main.style.minHeight = 'calc(100vh - ' + headerH + 'px)';

    let sidebarW = 0;
    if (sidebar) {
      const cs = getComputedStyle(sidebar);
      sidebarW = Math.round(sidebar.getBoundingClientRect().width || parseInt(cs.width, 10) || 82);
    }

    if (window.matchMedia('(max-width: 767.98px)').matches) {
      main.style.marginLeft = '0px';
    } else {
      main.style.marginLeft = sidebarW + 'px';
    }
  }

  function watchSidebar(){
    const main    = document.getElementById('historico-main');
    const sidebar = document.getElementById('sidebar');
    if (!main || !sidebar || !('MutationObserver' in window)) return;

    const mo = new MutationObserver(function(){
      const w = Math.round(sidebar.getBoundingClientRect().width || 0);
      if (window.matchMedia('(max-width: 767.98px)').matches) {
        main.style.marginLeft = '0px';
      } else {
        main.style.marginLeft = (w > 0 ? w : 82) + 'px';
      }
    });
    mo.observe(sidebar, { attributes:true, attributeFilter:['class', 'style'] });
  }

  const MONTHS_PT = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  const state = { ano: new Date().getFullYear(), mes: new Date().getMonth()+1, chart: null };
  const els = {
    months: document.getElementById('month-buttons'),
    year: document.getElementById('year-select'),
    btnRefresh: document.getElementById('btn-refresh'),
    kReceitas: document.getElementById('kpi-receitas'),
    kDespesas: document.getElementById('kpi-despesas'),
    kSaldo: document.getElementById('kpi-saldo'),
    kMetas: document.getElementById('kpi-metas'),
    range: document.getElementById('range-label'),
    tabOrcTbody: document.querySelector('#table-orcamento tbody'),
    orcTotal: document.getElementById('orcamento-total'),
    metasList: document.getElementById('metas-list'),
    metasResumo: document.getElementById('metas-resumo'),
    chartCanvas: document.getElementById('chart-mes')
  };
  const API = {
    orcamento: (ano, mes) => `/api/orcamento/resumo?ano=${ano}&mes=${mes}`,
    metas:     (ano, mes) => `/api/metas/resumo?ano=${ano}&mes=${mes}`
  };

  function initControls(){
    els.months.innerHTML = '';
    for(let i=1;i<=12;i++){
      const b = document.createElement('button');
      b.type = 'button'; b.className = 'btn'; b.textContent = MONTHS_PT[i-1];
      if(i === state.mes) b.classList.add('active');
      b.addEventListener('click', ()=>{ 
        state.mes = i; 
        els.months.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        loadAll();
      });
      els.months.appendChild(b);
    }
    const current = new Date().getFullYear();
    const start = current - 3, end = current + 1;
    els.year.innerHTML = '';
    for(let y=end; y>=start; y--){
      const opt = document.createElement('option');
      opt.value = y; opt.textContent = y; if (y===state.ano) opt.selected = true;
      els.year.appendChild(opt);
    }
    els.year.addEventListener('change', ()=>{ state.ano = parseInt(els.year.value,10); loadAll(); });
    els.btnRefresh?.addEventListener('click', loadAll);
  }

  async function loadAll(){
    if (els.range) els.range.textContent = `${MONTHS_PT[state.mes-1]} / ${state.ano}`;
    try{
      const [orc, metas] = await Promise.all([
        fetchJSON(API.orcamento(state.ano, state.mes)),
        fetchJSON(API.metas(state.ano, state.mes))
      ]);
      const receitas = +(orc?.totais?.receitas ?? 0);
      const despesas = +(orc?.totais?.despesas ?? 0);
      const saldo = receitas - despesas;
      const pctMetas = calcPctMetas(metas);

      els.kReceitas.textContent = formatBRL(receitas);
      els.kDespesas.textContent = formatBRL(despesas);
      els.kSaldo.textContent    = formatBRL(saldo);
      els.kMetas.textContent    = isNaN(pctMetas) ? '—' : `${pctMetas}%`;

      renderOrcamento(orc);
      renderMetas(metas);
      renderChart({ receitas, despesas, saldo });
    }catch(e){
      console.error(e);
      alert('Erro ao carregar dados do histórico.');
    }
  }

  function renderOrcamento(orc){
    const rows = orc?.categorias ?? [];
    els.tabOrcTbody.innerHTML = '';
    let totalPrev=0,totalGasto=0;
    rows.forEach(cat=>{
      const prev = +cat.previsto||0, gst = +cat.gasto||0, s = prev - gst;
      totalPrev += prev; totalGasto += gst;
      const pct = prev>0 ? Math.min(100, Math.round((gst/prev)*100)) : (gst>0?100:0);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escape(cat.nome ?? '—')}</td>
        <td class="text-end">${formatBRL(prev)}</td>
        <td class="text-end">${formatBRL(gst)}</td>
        <td class="text-end">${formatBRL(s)}</td>
        <td>
          <div class="progress-outer"><div class="progress-inner" style="width:${pct}%"></div></div>
          <div class="progress-label mt-1">${pct}% usado</div>
        </td>`;
      els.tabOrcTbody.appendChild(tr);
    });
    els.orcTotal.textContent = `Total Previsto: ${formatBRL(totalPrev)} — Gasto: ${formatBRL(totalGasto)}`;
  }

  function renderMetas(metas){
    const list = metas?.itens ?? [];
    const concl = list.filter(m => m.status === 'concluida').length;
    els.metasResumo.textContent = `${concl}/${list.length} concluídas`;
    els.metasList.innerHTML = '';
    list.forEach(m=>{
      const pct = Math.min(100, Math.round(m.progresso ?? 0));
      const card = document.createElement('div');
      card.className = 'meta-card';
      card.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="meta-title">${escape(m.titulo ?? 'Meta')}</div>
            <small class="text-muted">${escape(m.descricao ?? '')}</small>
          </div>
          <span class="badge ${m.status === 'concluida' ? 'bg-success' : 'bg-warning text-dark'}">
            ${m.status ?? 'pendente'}
          </span>
        </div>
        <div class="mt-2">
          <div class="progress-outer"><div class="progress-inner" style="width:${pct}%"></div></div>
          <div class="meta-foot mt-2">
            <span>Progresso: ${pct}%</span>
            ${m.valor_alvo ? `<span>Alvo: ${formatBRL(m.valor_alvo)}</span>` : ''}
          </div>
        </div>`;
      els.metasList.appendChild(card);
    });
  }

  function renderChart({ receitas, despesas, saldo }){
    if (!window.Chart || !els.chartCanvas) return;
    if (state.chart) state.chart.destroy();
    const ctx = els.chartCanvas.getContext('2d');
    state.chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Receitas','Despesas','Saldo'],
        datasets: [{ label: `${MONTHS_PT[state.mes-1]} / ${state.ano}`, data: [receitas, despesas, saldo] }]
      },
      options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  async function fetchJSON(url){ const r = await fetch(url,{headers:{Accept:'application/json'}}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
  function formatBRL(v){ try{ return (v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }catch{ return 'R$ '+Number(v||0).toFixed(2); } }
  function calcPctMetas(m){ const list=m?.itens??[]; if(!list.length) return 0; const done=list.filter(x=>x.status==='concluida').length; return Math.round((done/list.length)*100); }
  function escape(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function boot(){
    applyOffsets();
    watchSidebar();
    initControls();
    loadAll();
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();

  window.addEventListener('resize', applyOffsets);

})();
</script>

{% endblock %}